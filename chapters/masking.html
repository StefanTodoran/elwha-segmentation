
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>River Boundary Masking &#8212; Elwha Dataset Realignment</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Cold Water Refuge Mapping" href="elwha.html" />
    <link rel="prev" title="Dataset Realignment Discussion" href="discussion.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/GeoSMART_logo.svg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Elwha Dataset Realignment</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  About
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://geo-smart.github.io/index.html">
   Geosmart Website
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Dataset Reconstruction
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="realignment.html">
   Elwha River Offset Arial Photo Matching
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="discussion.html">
   Dataset Realignment Discussion
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Further Processing
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   River Boundary Masking
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="elwha.html">
   Cold Water Refuge Mapping
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Dataset Minification
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="minify_skip.html">
   Tutorial on Dataset Minification
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Reference
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../reference/glossary.html">
   Glossaries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../reference/bibliography.html">
   Bibliography
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/StefanTodoran/elwha_dataset_realignment/main?urlpath=lab/tree/book/chapters/masking.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/StefanTodoran/elwha_dataset_realignment"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/StefanTodoran/elwha_dataset_realignment/issues/new?title=Issue%20on%20page%20%2Fchapters/masking.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/StefanTodoran/elwha_dataset_realignment/edit/main/book/chapters/masking.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/chapters/masking.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dataset">
   Dataset
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>River Boundary Masking</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dataset">
   Dataset
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="river-boundary-masking">
<h1>River Boundary Masking<a class="headerlink" href="#river-boundary-masking" title="Permalink to this headline">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h2>
<p>Cold water refuges are crucial havens for fish species, offering them sanctuary and relief. These refuges are specific areas within aquatic ecosystems, such as deep pools or shaded sections, where the water remains relatively colder than the surrounding environment. With the increasing impact of climate change and its associated rising temperatures, cold water refuges serve as essential habitats for fish, providing them with a reprieve from stressful conditions and enabling their survival and reproductive success. By seeking out these refuges, fish can maintain optimal physiological functioning, evade thermal stress, and ensure the long-term sustainability of their populations.</p>
<p>In this section, we will use our realign dataset to create river masks for our IR images. These masks will then be used to identify cold water refuges in the river in the next section. The segmentation model selected for use is Metaâ€™s SAM. The workflow overview of how it is utilized to create river masks is as follows:</p>
<ul class="simple">
<li><p>Create a small training dataset by hand using <a class="reference external" href="http://paint.net">paint.net</a></p></li>
<li><p>Split said dataset into training, testing and validation</p></li>
<li><p>Create mechanism for creating point prompts for SAM</p></li>
<li><p>Fine tune SAM via transfer learning on the training data</p></li>
<li><p>Evaluate model performance and generate masks</p></li>
</ul>
</section>
<section id="dataset">
<h2>Dataset<a class="headerlink" href="#dataset" title="Permalink to this headline">#</a></h2>
<p>The first step is to build our ground truth dataset. It seems that the original processing done in 2012 included some preliminary river masks. Unfortunately, these masks are fairly poor. They also do not help with the construction of our ground truth dataset; it is easier to just manually create new masks than it is to patch up the existing masks.</p>
<p>The process of creating ground truth masks involves using the magic wand tool in <a class="reference external" href="http://paint.net">paint.net</a>, which selects an contiguous area of similar color based on some tolerance value. Then this area is filled with black and the rest of the image with white, and the mask can then be manually adjusted to match the river in areas where the magic wand fails to align perfectly with the river edge.</p>
<p>The optimal results are achieved by using RGB images layered with transparency over the IR images, as the IR images have the highest contrast between river and non-river pixels. This is because reflectance of water is lower than soil and vegetation across a wide range of the electromagnetic spectrum, including within the visible RGB portion, but the difference is most significant in the IR range.</p>
<p><img alt="Quadrant Filtering" src="../_images/reflectance.png" /></p>
<p>The difference in reflectance then results in the contrast between the river and land pixels being larger in the IR images. This also means that while both the RGB and IR remote sensing imagery may prove relevant to the model, the IR images will be the key to accurate segmentation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import os</span>
<span class="c1"># os.environ[&quot;KMP_DUPLICATE_LIB_OK&quot;]=&quot;TRUE&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">util</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span> <span class="k">as</span> <span class="n">im</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>

<span class="c1"># System and typing</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Finding central points</span>
<span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="kn">import</span> <span class="n">erosion</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torchvision.datasets.vision</span> <span class="kn">import</span> <span class="n">VisionDataset</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="c1"># from torchvision import transforms</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have our ground truth masks, we need a PyTorch datastructure through which we can use them. We will extend the VisionDataset class, creating our own SegmentationDataset class which has support for transforms. This will come in handy later when we do dataset augmentation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Adapted from Manpreet Singh Minhas&#39;s transfer learning</span>
<span class="sd">for semantic segmentation tutorial.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">SegmentationDataset</span><span class="p">(</span><span class="n">VisionDataset</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A PyTorch dataset for image segmentation task.</span>
<span class="sd">  The dataset is compatible with torchvision transforms.</span>
<span class="sd">  The transforms passed would be applied to both the Images and Masks.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ir_folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">rgb_folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">masks_folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>

    <span class="n">ir_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">rgb_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">masks_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>

    <span class="n">transforms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">subset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    
    <span class="n">mask_color_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;grayscale&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ARGS:</span>
<span class="sd">      root (str): Used for super init of VisionDataset.</span>
<span class="sd">      ir_folder (str): Folder containing the ir images.</span>
<span class="sd">      rgb_folder (str): Folder containing the rgb images.</span>
<span class="sd">      masks_folder (str): Folder containing the segmentation truth mask images.</span>
<span class="sd">      ir_prefix (str): Prefix string for ir images, e.g. &quot;ir_image_&quot; if stored as ir_image_1, ir_image_2 ...</span>
<span class="sd">      rgb_prefix (str): Prefix string for the rgb images.</span>
<span class="sd">      masks_prefix (str): Prefix string for the segmentation truth mask images.</span>

<span class="sd">      transforms (Optional[Callable], optional): A function/transform that takes in</span>
<span class="sd">          a sample and returns a transformed version. E.g, ``transforms.ToTensor`` for images.</span>
<span class="sd">      seed (int, optional): Specify a seed for the train and test split for reproducible results. Defaults to None.</span>
<span class="sd">      fraction (float, optional): A float value from 0 to 1 which specifies the validation split fraction. Defaults to None.</span>
<span class="sd">      subset (str, optional): &quot;Train&quot; or &quot;Test&quot; to select the appropriate set. Defaults to None.</span>

<span class="sd">      mask_color_mode (str, optional): &quot;rgb&quot; or &quot;grayscale&quot;. Defaults to &quot;grayscale&quot;.</span>
<span class="sd">    </span>
<span class="sd">    RAISES:</span>
<span class="sd">      OSError: If any of ir_folder, rgb_folder or masks_folder do not exist.</span>
<span class="sd">      ValueError: If subset is not either &quot;Train&quot; or &quot;Test&quot;.</span>
<span class="sd">      ValueError: If image_color_mode and mask_color_mode are either &quot;rgb&quot; or &quot;grayscale&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">transforms</span><span class="p">)</span>

    <span class="n">ir_images_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span> <span class="o">/</span> <span class="n">ir_folder</span>
    <span class="n">rgb_images_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span> <span class="o">/</span> <span class="n">rgb_folder</span>
    <span class="n">mask_images_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span> <span class="o">/</span> <span class="n">masks_folder</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ir_images_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
      <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ir_images_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rgb_images_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
      <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rgb_images_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mask_images_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
      <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mask_images_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mask_color_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;rgb&quot;</span><span class="p">,</span> <span class="s2">&quot;grayscale&quot;</span><span class="p">]:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mask_color_mode</span><span class="si">}</span><span class="s2"> is an invalid choice. Please enter from rgb grayscale.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mask_color_mode</span> <span class="o">=</span> <span class="n">mask_color_mode</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">fraction</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">mask_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mask_images_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">masks_prefix</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">subset</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Train&quot;</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2"> is not a valid input. Acceptable values are Train and Test.&quot;</span><span class="p">)</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">fraction</span> <span class="o">=</span> <span class="n">fraction</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">mask_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">mask_images_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">masks_prefix</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">onlyNumeric</span><span class="p">))</span>
      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found and loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> ground truth segmentation masks.&quot;</span><span class="p">)</span>
      
      <span class="c1"># we don&#39;t have an rgb reconstruction for every ir image</span>
      <span class="c1"># and definitely don&#39;t have a mask for every rgb + ir pair</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">ir_image_list</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">rgb_image_list</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_list</span><span class="p">:</span>
        <span class="n">number</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">onlyNumeric</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ir_image_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ir_images_path</span> <span class="o">/</span> <span class="p">(</span><span class="n">ir_prefix</span> <span class="o">+</span> <span class="n">number</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgb_image_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rgb_images_path</span> <span class="o">/</span> <span class="p">(</span><span class="n">rgb_prefix</span> <span class="o">+</span> <span class="n">number</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">))</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">ir_image_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ir_image_list</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">rgb_image_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rgb_image_list</span><span class="p">)</span>
      <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ir_image_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rgb_image_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_list</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">seed</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_list</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ir_image_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ir_image_list</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgb_image_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb_image_list</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_list</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>


      <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s2">&quot;Train&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ir_image_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ir_image_list</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span>
          <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ir_image_list</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction</span><span class="p">)))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgb_image_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb_image_list</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span>
          <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ir_image_list</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction</span><span class="p">)))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_list</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span>
          <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_list</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction</span><span class="p">)))]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ir_image_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ir_image_list</span><span class="p">[</span>
          <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ir_image_list</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction</span><span class="p">))):]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgb_image_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb_image_list</span><span class="p">[</span>
          <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rgb_image_list</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction</span><span class="p">))):]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_list</span><span class="p">[</span>
          <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_list</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction</span><span class="p">))):]</span>
        
      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subset of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> ground truth segmentation masks marked for </span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_names</span><span class="p">)</span>
  
  <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">ir_image_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ir_image_names</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">rgb_image_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb_image_names</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">mask_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_names</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">with</span> <span class="p">(</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">ir_image_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ir_image_file</span><span class="p">,</span> 
        <span class="nb">open</span><span class="p">(</span><span class="n">rgb_image_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">rgb_image_file</span><span class="p">,</span> 
        <span class="nb">open</span><span class="p">(</span><span class="n">mask_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mask_file</span>
      <span class="p">):</span>
        <span class="n">ir_image</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ir_image_file</span><span class="p">)</span>
        <span class="n">ir_image</span> <span class="o">=</span> <span class="n">ir_image</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">)</span>
        
        <span class="n">rgb_image</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgb_image_file</span><span class="p">)</span>
        <span class="n">rgb_image</span> <span class="o">=</span> <span class="n">rgb_image</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
        
        <span class="n">mask</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mask_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_color_mode</span> <span class="o">==</span> <span class="s2">&quot;rgb&quot;</span><span class="p">:</span>
          <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
        
        <span class="n">sample</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">&quot;ir&quot;</span><span class="p">:</span> <span class="n">ir_image</span><span class="p">,</span> <span class="s2">&quot;rgb&quot;</span><span class="p">:</span> <span class="n">rgb_image</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">,</span>
          <span class="s2">&quot;ir_path&quot;</span><span class="p">:</span> <span class="n">ir_image_path</span><span class="p">,</span> <span class="s2">&quot;rgb_path&quot;</span><span class="p">:</span> <span class="n">rgb_image_path</span><span class="p">,</span> <span class="s2">&quot;mask_path&quot;</span><span class="p">:</span> <span class="n">mask_path</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">:</span>
          <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;ir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;ir&quot;</span><span class="p">])</span>
          <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;rgb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;rgb&quot;</span><span class="p">])</span>
          <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">sample</span>
</pre></div>
</div>
</div>
</div>
<p>The custom dataset class is used as follows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ir_folder</span> <span class="o">=</span> <span class="s2">&quot;data/img/&quot;</span>
<span class="n">ir_prefix</span> <span class="o">=</span> <span class="s2">&quot;airborne_ir_&quot;</span>

<span class="n">rgb_folder</span> <span class="o">=</span> <span class="s2">&quot;out/realignment/&quot;</span>
<span class="n">rgb_prefix</span> <span class="o">=</span> <span class="s2">&quot;rgb_&quot;</span>

<span class="n">truth_folder</span> <span class="o">=</span> <span class="s2">&quot;truth/&quot;</span>
<span class="n">truth_prefix</span> <span class="o">=</span> <span class="s2">&quot;truth_&quot;</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">SegmentationDataset</span><span class="p">(</span>
    <span class="s2">&quot;../&quot;</span><span class="p">,</span> <span class="n">ir_folder</span><span class="p">,</span> <span class="n">rgb_folder</span><span class="p">,</span> <span class="n">truth_folder</span><span class="p">,</span> <span class="n">ir_prefix</span><span class="p">,</span> <span class="n">rgb_prefix</span><span class="p">,</span> <span class="n">truth_prefix</span><span class="p">,</span> 
    <span class="n">transforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s2">&quot;Train&quot;</span><span class="p">,</span> <span class="n">mask_color_mode</span><span class="o">=</span><span class="s2">&quot;rgb&quot;</span>
<span class="p">)</span>
<span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found and loaded 8 ground truth segmentation masks.
Subset of 6 ground truth segmentation masks marked for Train.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datapoint_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span>
  <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Datapoint:&quot;</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">updateDatapoint</span><span class="p">(</span><span class="n">interpolation</span><span class="p">):</span>
  <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">interpolation</span><span class="p">)</span>
  <span class="n">datapoint</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
  <span class="n">figure</span><span class="p">,</span> <span class="p">(</span><span class="n">rgb_ax</span><span class="p">,</span> <span class="n">ir_ax</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

  <span class="n">rgb_ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="s2">&quot;ir&quot;</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;hot&quot;</span><span class="p">)</span>
  <span class="n">ir_ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="s2">&quot;rgb&quot;</span><span class="p">])</span>

<span class="c1"># sample_idx = torch.randint(len(data), size=(1,)).item()</span>
<span class="c1"># datapoint = data[sample_idx] # type: ignore</span>

<span class="n">data_preview</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span><span class="n">updateDatapoint</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">datapoint_slider</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">data_preview</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "420f75419e624b44a8ad30c83989afd1", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<p>Set the <code class="docutils literal notranslate"><span class="pre">datapoint</span></code> variable to the data point selected above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datapoint</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">datapoint_slider</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
<span class="n">rgb_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="s2">&quot;rgb_path&quot;</span><span class="p">]))</span>
<span class="n">ir_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="s2">&quot;ir_path&quot;</span><span class="p">]),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">createRoughMaskFromIR</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">binary_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">(</span><span class="n">binary_image</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">createRoughMaskFromHSVBounds</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">lower_blue</span><span class="p">,</span> <span class="n">upper_blue</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Creates a binary mask from the provided image where any blue pixels in the</span>
<span class="sd">  original image are set to black in the mask, and all other pixels are white in the mask.</span>

<span class="sd">  ARGS:</span>
<span class="sd">    image (Mat): A cv2 image in RGB format.</span>
<span class="sd">    lower_blue (list[int]): A list of 3 integer numbers denoting in HSV colorspace the lower</span>
<span class="sd">    bound for what is considered blue. Note that hue should range from 0-179, while saturation</span>
<span class="sd">    and value should range from 0-255, as per cv2&#39;s implementation.</span>
<span class="sd">    upper_blue (list[int]): A list of 3 integer numbers denoting in HSV colorspace the upper</span>
<span class="sd">    bound for what is considered blue.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># Convert image to HSV color space</span>
  <span class="n">hsv_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2HSV</span><span class="p">)</span>

  <span class="c1"># Define lower and upper bounds for blue color in HSV</span>
  <span class="n">lower_blue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lower_blue</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
  <span class="n">upper_blue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">upper_blue</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

  <span class="c1"># Create a mask for blue pixels within the HSV bounds</span>
  <span class="n">blue_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="n">hsv_image</span><span class="p">,</span> <span class="n">lower_blue</span><span class="p">,</span> <span class="n">upper_blue</span><span class="p">)</span>

  <span class="n">blank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span> <span class="c1"># create a blank white image of the same size as the original image</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">blank</span><span class="p">,</span> <span class="n">blank</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">blue_mask</span><span class="p">)</span> <span class="c1"># set blue pixels in the white image to black</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
  
  <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">findMaskIntersection</span><span class="p">(</span><span class="n">mask1</span><span class="p">,</span> <span class="n">mask2</span><span class="p">):</span>
  <span class="c1"># Ensure the masks have the same dimensions</span>
  <span class="k">if</span> <span class="n">mask1</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mask2</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mask images must have the same dimensions.&quot;</span><span class="p">)</span>

  <span class="c1"># Invert the masks</span>
  <span class="n">inverted_mask1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">(</span><span class="n">mask1</span><span class="p">)</span>
  <span class="n">inverted_mask2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">(</span><span class="n">mask2</span><span class="p">)</span>

  <span class="c1"># Compute the intersection of the inverted masks</span>
  <span class="n">intersection</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">inverted_mask1</span><span class="p">,</span> <span class="n">inverted_mask2</span><span class="p">))</span>

  <span class="k">return</span> <span class="n">intersection</span>

<span class="k">def</span> <span class="nf">createRoughRiverMask</span><span class="p">(</span><span class="n">rgb_image</span><span class="p">,</span> <span class="n">ir_image</span><span class="p">,</span> <span class="n">low_blue</span><span class="p">,</span> <span class="n">high_blue</span><span class="p">,</span> <span class="n">max_temp</span><span class="p">,</span> <span class="n">return_components</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="n">mask1</span> <span class="o">=</span> <span class="n">createRoughMaskFromHSVBounds</span><span class="p">(</span><span class="n">rgb_image</span><span class="p">,</span> <span class="n">low_blue</span><span class="p">,</span> <span class="n">high_blue</span><span class="p">)</span>
  <span class="n">mask2</span> <span class="o">=</span> <span class="n">createRoughMaskFromIR</span><span class="p">(</span><span class="n">ir_image</span><span class="p">,</span> <span class="n">max_temp</span><span class="p">)</span>
  
  <span class="k">if</span> <span class="n">return_components</span><span class="p">:</span> <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">mask1</span><span class="p">,</span> <span class="n">mask2</span><span class="p">),</span> <span class="n">mask1</span><span class="p">,</span> <span class="n">mask2</span>
  <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">mask1</span><span class="p">,</span> <span class="n">mask2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hue_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntRangeSlider</span><span class="p">(</span>
  <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">75</span><span class="p">,</span> <span class="mi">140</span><span class="p">],</span>
  <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">179</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Hue:&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">sat_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntRangeSlider</span><span class="p">(</span>
  <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
  <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Saturation:&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">val_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntRangeSlider</span><span class="p">(</span>
  <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">230</span><span class="p">],</span>
  <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Value:&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">temp_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span>
  <span class="n">value</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
  <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Max Temperature:&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">updateRoughMasks</span><span class="p">(</span><span class="n">hue_range</span><span class="p">,</span> <span class="n">sat_range</span><span class="p">,</span> <span class="n">val_range</span><span class="p">,</span> <span class="n">max_temp</span><span class="p">):</span>
  <span class="n">low_blue</span> <span class="o">=</span> <span class="p">[</span><span class="n">hue_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sat_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
  <span class="n">high_blue</span> <span class="o">=</span> <span class="p">[</span><span class="n">hue_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sat_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">val_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

  <span class="n">hsv_mask</span> <span class="o">=</span> <span class="n">createRoughMaskFromHSVBounds</span><span class="p">(</span><span class="n">rgb_image</span><span class="p">,</span> <span class="n">low_blue</span><span class="p">,</span> <span class="n">high_blue</span><span class="p">)</span>
  <span class="n">temp_mask</span> <span class="o">=</span> <span class="n">createRoughMaskFromIR</span><span class="p">(</span><span class="n">ir_image</span><span class="p">,</span> <span class="n">max_temp</span><span class="p">)</span>
  <span class="n">result_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">hsv_mask</span><span class="p">,</span> <span class="n">temp_mask</span><span class="p">)</span>

  <span class="n">masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">hsv_mask</span><span class="p">,</span> <span class="n">temp_mask</span><span class="p">,</span> <span class="n">result_mask</span><span class="p">]</span>
  <span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">))</span>

  <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

  <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">interactive_plot</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span>
  <span class="n">updateRoughMasks</span><span class="p">,</span> 
  <span class="n">hue_range</span><span class="o">=</span><span class="n">hue_slider</span><span class="p">,</span>
  <span class="n">sat_range</span><span class="o">=</span><span class="n">sat_slider</span><span class="p">,</span>
  <span class="n">val_range</span><span class="o">=</span><span class="n">val_slider</span><span class="p">,</span>
  <span class="n">max_temp</span><span class="o">=</span><span class="n">temp_slider</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">interactive_plot</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "979c2da43716449dbc13458c79952fba", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getRoughRiverMask</span><span class="p">(</span><span class="n">datapoint</span><span class="p">,</span> <span class="n">do_print</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">return_components</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="n">rgb_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="s2">&quot;rgb_path&quot;</span><span class="p">]))</span>
  <span class="n">ir_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="s2">&quot;ir_path&quot;</span><span class="p">]),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>

  <span class="n">low_blue</span> <span class="o">=</span> <span class="p">[</span><span class="n">hue_slider</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sat_slider</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val_slider</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="c1"># [75, 10, 20]</span>
  <span class="n">high_blue</span> <span class="o">=</span> <span class="p">[</span><span class="n">hue_slider</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sat_slider</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">val_slider</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="c1"># [140, 200, 230]</span>

  <span class="k">if</span> <span class="n">do_print</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating mask via HSV thresholding...</span><span class="se">\n</span><span class="s2">Bounds:&quot;</span><span class="p">,</span> <span class="n">low_blue</span><span class="p">,</span> <span class="n">high_blue</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">createRoughRiverMask</span><span class="p">(</span><span class="n">rgb_image</span><span class="p">,</span> <span class="n">ir_image</span><span class="p">,</span> <span class="n">low_blue</span><span class="p">,</span> <span class="n">high_blue</span><span class="p">,</span> <span class="n">temp_slider</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">return_components</span><span class="p">)</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">getRoughRiverMask</span><span class="p">(</span><span class="n">datapoint</span><span class="p">,</span> <span class="n">do_print</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;on&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Creating mask via HSV thresholding...
Bounds: [75, 10, 20] [140, 200, 230]
</pre></div>
</div>
<img alt="../_images/masking_14_1.png" src="../_images/masking_14_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Adapted from Facebook&#39;s SAM predictor </span>
<span class="sd">example workflow notebook.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">show_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">random_color</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">random_color</span><span class="p">:</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.6</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">30</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">144</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span>
  <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
  <span class="n">mask_image</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">color</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask_image</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">show_points</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker_size</span><span class="o">=</span><span class="mi">375</span><span class="p">):</span>
  <span class="n">pos_points</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">labels</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">neg_points</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">labels</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pos_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pos_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">marker_size</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.25</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">neg_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">neg_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">marker_size</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.25</span><span class="p">)</span>   
    
<span class="k">def</span> <span class="nf">show_box</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
  <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">controlPointsFromMask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="n">input_points</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">def</span> <span class="nf">euclideanDistance</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

  <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_points</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">number</span><span class="p">:</span>
    <span class="n">zero_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">positive</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zero_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

      <span class="n">found_valid</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="k">while</span> <span class="ow">not</span> <span class="n">found_valid</span><span class="p">:</span>
        <span class="n">random_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">zero_indices</span><span class="p">))</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">zero_indices</span><span class="p">[</span><span class="n">random_index</span><span class="p">]</span>
        <span class="n">new_point</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">]</span>
        
        <span class="c1"># Check if the new point is far enough from existing points</span>
        <span class="n">too_close</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">input_points</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">euclideanDistance</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">new_point</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="p">:</span>
            <span class="n">too_close</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">too_close</span><span class="p">:</span>
          <span class="n">input_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_point</span><span class="p">)</span>
          <span class="n">found_valid</span> <span class="o">=</span> <span class="kc">True</span>
          <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">zero_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">zero_indices</span><span class="p">,</span> <span class="n">random_index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zero_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
      <span class="c1"># end while</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">found_valid</span><span class="p">:</span> <span class="c1"># There are points left but none with enough distance between them.</span>
        <span class="k">break</span>
    
    <span class="k">else</span><span class="p">:</span>
      <span class="k">break</span>  <span class="c1"># We have fewer than &quot;number&quot; points, but there are no valid points left.</span>

  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_points</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">generateInputPointsFromMask</span><span class="p">(</span>
  <span class="n">number</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
  <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
  <span class="n">minDistance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">negativeSrcMask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="n">numNegative</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="n">positiveSrcMask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="n">numPositive</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
  <span class="n">input_points</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">input_labels</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="n">_numNegative</span> <span class="o">=</span> <span class="n">numNegative</span> <span class="k">if</span> <span class="n">numNegative</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">number</span>
  <span class="k">if</span> <span class="n">_numNegative</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">control_points</span> <span class="o">=</span> <span class="n">controlPointsFromMask</span><span class="p">(</span>
      <span class="n">negativeSrcMask</span> <span class="k">if</span> <span class="n">negativeSrcMask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mask</span><span class="p">,</span>
      <span class="n">_numNegative</span><span class="p">,</span>
      <span class="n">distance</span><span class="o">=</span><span class="n">minDistance</span>
    <span class="p">)</span>
    <span class="n">input_points</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">control_points</span><span class="p">)</span>
    <span class="n">input_labels</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">control_points</span><span class="p">))</span>

  <span class="n">_numPositive</span> <span class="o">=</span> <span class="n">numPositive</span> <span class="k">if</span> <span class="n">numPositive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">number</span>
  <span class="k">if</span> <span class="n">_numPositive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">control_points</span> <span class="o">=</span> <span class="n">controlPointsFromMask</span><span class="p">(</span>
      <span class="n">positiveSrcMask</span> <span class="k">if</span> <span class="n">positiveSrcMask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mask</span><span class="p">,</span>
      <span class="n">_numPositive</span><span class="p">,</span>
      <span class="n">distance</span><span class="o">=</span><span class="n">minDistance</span><span class="p">,</span>
      <span class="n">positive</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">input_points</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">control_points</span><span class="p">)</span>
    <span class="n">input_labels</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">control_points</span><span class="p">))</span>

  <span class="n">input_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_points</span><span class="p">)</span>
  <span class="n">input_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_labels</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">input_points</span><span class="p">,</span> <span class="n">input_labels</span>

<span class="n">square</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
  <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
  <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
  <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
<span class="p">])</span>

<span class="k">def</span> <span class="nf">multiErode</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="n">square</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">erosion</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">im</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">segment_anything</span> <span class="kn">import</span> <span class="n">sam_model_registry</span><span class="p">,</span> <span class="n">SamPredictor</span>

<span class="c1"># TODO: fetch model if it isn&#39;t downloaded</span>
<span class="n">sam_checkpoint</span> <span class="o">=</span> <span class="s2">&quot;../data/model/sam_vit_h_4b8939.pth&quot;</span>
<span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;vit_h&quot;</span>

<span class="c1"># device = &quot;cuda&quot;</span>
<span class="n">device</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">sam</span> <span class="o">=</span> <span class="n">sam_model_registry</span><span class="p">[</span><span class="n">model_type</span><span class="p">](</span><span class="n">checkpoint</span><span class="o">=</span><span class="n">sam_checkpoint</span><span class="p">)</span>
<span class="n">sam</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">predictor</span> <span class="o">=</span> <span class="n">SamPredictor</span><span class="p">(</span><span class="n">sam</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="s2">&quot;ir_path&quot;</span><span class="p">]))</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">getRoughRiverMask</span><span class="p">(</span><span class="n">datapoint</span><span class="p">)</span>
<span class="n">input_points</span><span class="p">,</span> <span class="n">input_labels</span> <span class="o">=</span> <span class="n">generateInputPointsFromMask</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">show_points</span><span class="p">(</span><span class="n">input_points</span><span class="p">,</span> <span class="n">input_labels</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/masking_18_0.png" src="../_images/masking_18_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">erode_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span>
  <span class="n">value</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
  <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Erosion Factor:&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">distance_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span>
  <span class="n">value</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
  <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
  <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Min Distance:&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">points_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span>
  <span class="n">value</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
  <span class="nb">min</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Control Points:&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">getControlPoints</span><span class="p">(</span>
  <span class="n">num_points</span> <span class="o">=</span> <span class="n">points_slider</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> 
  <span class="n">erosion_factor</span> <span class="o">=</span> <span class="n">erode_slider</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> 
  <span class="n">min_distance</span> <span class="o">=</span> <span class="n">distance_slider</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> 
  <span class="n">give_erosion_mask</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
  <span class="n">mask</span> <span class="o">=</span> <span class="n">getRoughRiverMask</span><span class="p">(</span><span class="n">datapoint</span><span class="p">)</span>
  <span class="n">binarized</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&gt;</span> <span class="mi">1</span>
  <span class="n">eroded</span> <span class="o">=</span> <span class="n">multiErode</span><span class="p">(</span><span class="n">binarized</span><span class="p">,</span> <span class="n">erosion_factor</span><span class="p">)</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">generateInputPointsFromMask</span><span class="p">(</span><span class="n">numPositive</span><span class="o">=</span><span class="n">num_points</span><span class="p">,</span> <span class="n">positiveSrcMask</span><span class="o">=</span><span class="n">eroded</span><span class="p">,</span> <span class="n">minDistance</span><span class="o">=</span><span class="n">min_distance</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">give_erosion_mask</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">eroded</span><span class="p">,</span> <span class="n">result</span>
  <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">updateControlPoints</span><span class="p">(</span><span class="n">erosion_factor</span><span class="p">,</span> <span class="n">num_points</span><span class="p">,</span> <span class="n">min_distance</span><span class="p">,</span> <span class="n">force_refresh</span><span class="p">):</span>
  <span class="n">eroded</span><span class="p">,</span> <span class="p">(</span><span class="n">input_points</span><span class="p">,</span> <span class="n">input_labels</span><span class="p">)</span> <span class="o">=</span> <span class="n">getControlPoints</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">erosion_factor</span><span class="p">,</span> <span class="n">min_distance</span><span class="p">,</span> <span class="n">give_erosion_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

  <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">eroded</span><span class="p">)</span>
  <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
  <span class="n">show_points</span><span class="p">(</span><span class="n">input_points</span><span class="p">,</span> <span class="n">input_labels</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

  <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">randomize_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">ToggleButton</span><span class="p">(</span>
  <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
  <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Generate&quot;</span><span class="p">,</span>
  <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">interactive_plot</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span>
  <span class="n">updateControlPoints</span><span class="p">,</span> 
  <span class="n">erosion_factor</span><span class="o">=</span><span class="n">erode_slider</span><span class="p">,</span>
  <span class="n">num_points</span><span class="o">=</span><span class="n">points_slider</span><span class="p">,</span>
  <span class="n">min_distance</span><span class="o">=</span><span class="n">distance_slider</span><span class="p">,</span>
  <span class="n">force_refresh</span><span class="o">=</span><span class="n">randomize_button</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">interactive_plot</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "27c588d05bb14ec3aceebd6b0e445a3f", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<p>Facebookâ€™s SAM provides 3 model sizes. For our purposes the smallest of the three, ViT-B, will suffice. The model checkpoint can be downloaded from <a class="reference external" href="https://github.com/facebookresearch/segment-anything#model-checkpoints">this</a> link.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_points</span><span class="p">,</span> <span class="n">input_labels</span> <span class="o">=</span> <span class="n">getControlPoints</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">show_points</span><span class="p">(</span><span class="n">input_points</span><span class="p">,</span> <span class="n">input_labels</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/masking_21_0.png" src="../_images/masking_21_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictor</span><span class="o">.</span><span class="n">set_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
  <span class="n">point_coords</span><span class="o">=</span><span class="n">input_points</span><span class="p">,</span>
  <span class="n">point_labels</span><span class="o">=</span><span class="n">input_labels</span><span class="p">,</span>
  <span class="n">multimask_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">)):</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
  <span class="n">show_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
  <span class="n">show_points</span><span class="p">(</span><span class="n">input_points</span><span class="p">,</span> <span class="n">input_labels</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">, Score: </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/masking_24_0.png" src="../_images/masking_24_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">evaluateMaskAccuracy</span><span class="p">(</span><span class="n">datapoint</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">control_points</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">best_values</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="n">best_input_points</span> <span class="o">=</span> <span class="n">best_input_labels</span> <span class="o">=</span> <span class="n">best_index</span> <span class="o">=</span> <span class="n">best_score</span> <span class="o">=</span> <span class="n">all_scores</span> <span class="o">=</span> <span class="n">best_erosion</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="k">if</span> <span class="n">control_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">best_input_points</span><span class="p">,</span> <span class="n">best_input_labels</span> <span class="o">=</span> <span class="n">control_points</span>
  <span class="k">if</span> <span class="n">best_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">best_index</span><span class="p">,</span> <span class="n">best_score</span><span class="p">,</span> <span class="n">all_scores</span><span class="p">,</span> <span class="n">best_erosion</span> <span class="o">=</span> <span class="n">best_values</span>

  <span class="n">rgb_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="s2">&quot;rgb_path&quot;</span><span class="p">]))</span>
  <span class="n">rgb_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">rgb_image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
  
  <span class="n">truth</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="s2">&quot;mask_path&quot;</span><span class="p">]))</span>
  <span class="n">truth</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">(</span><span class="n">truth</span><span class="p">)[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

  <span class="n">prediction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="n">error</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_xor</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">truth</span><span class="p">)</span>

  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Misclasified pixels:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total river pixels:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">truth</span><span class="p">))</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error rate: </span><span class="si">{</span><span class="mi">100</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">truth</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

  <span class="c1"># print(f&quot;Error rate: {100 * round(np.count_nonzero(error) / (prediction.shape[0] * prediction.shape[1]), 4)}%&quot;)</span>

  <span class="n">plot_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">rgb_image</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">truth</span><span class="p">,</span> <span class="n">error</span><span class="p">]</span>
  <span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">plot_images</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>

  <span class="k">if</span> <span class="n">control_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">show_mask</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">show_points</span><span class="p">(</span><span class="n">best_input_points</span><span class="p">,</span> <span class="n">best_input_labels</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

  <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_images</span><span class="p">):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">best_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">plot_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Mask </span><span class="si">{</span><span class="n">best_index</span><span class="si">}</span><span class="s2"> (Score: </span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="k">if</span> <span class="n">best_erosion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">plot_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Mask </span><span class="si">{</span><span class="n">best_index</span><span class="si">}</span><span class="s2"> (Erosion: </span><span class="si">{</span><span class="n">best_erosion</span><span class="si">}</span><span class="s2">, Score: </span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Minimum Score: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">all_scores</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Median Score: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">all_scores</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean Score: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_scores</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evaluateMaskAccuracy</span><span class="p">(</span><span class="n">datapoint</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">input_points</span><span class="p">,</span> <span class="n">input_labels</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Misclasified pixels: 5374
Total river pixels: 17676
Error rate: 30.4%
</pre></div>
</div>
<img alt="../_images/masking_26_2.png" src="../_images/masking_26_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">bestOfMultiRoundPrediction</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">num_rounds</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">erosion_range</span><span class="p">:</span> <span class="nb">range</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="c1"># print(&quot;Setting predictor image...&quot;, end=&quot;\r&quot;)</span>
  <span class="n">predictor</span><span class="o">.</span><span class="n">set_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

  <span class="n">all_scores</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="n">best_index</span><span class="p">,</span> <span class="n">best_mask</span><span class="p">,</span> <span class="n">best_score</span><span class="p">,</span> <span class="n">best_erosion</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
  <span class="n">best_input_points</span><span class="p">,</span> <span class="n">best_input_labels</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

  <span class="n">_erosion_range</span> <span class="o">=</span> <span class="n">erosion_range</span> <span class="k">if</span> <span class="n">erosion_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

  <span class="k">for</span> <span class="n">erosion_val</span> <span class="ow">in</span> <span class="n">_erosion_range</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_rounds</span><span class="p">):</span>
      <span class="c1"># print(f&quot;Computing prediction round #{i} with erosion={erosion_val}&quot;, end=&quot;   \r&quot;)</span>
      <span class="n">input_points</span><span class="p">,</span> <span class="n">input_labels</span> <span class="o">=</span> <span class="n">getControlPoints</span><span class="p">(</span><span class="n">erosion_factor</span><span class="o">=</span><span class="n">erosion_val</span><span class="p">)</span>

      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
      <span class="n">masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">_logits</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">point_coords</span><span class="o">=</span><span class="n">input_points</span><span class="p">,</span>
        <span class="n">point_labels</span><span class="o">=</span><span class="n">input_labels</span><span class="p">,</span>
        <span class="c1"># multimask_output=True,</span>
        <span class="n">multimask_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
      <span class="p">)</span>
      
      <span class="n">all_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">):</span>
        <span class="n">best_index</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">best_score</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">best_mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">best_erosion</span> <span class="o">=</span> <span class="n">erosion_val</span>

        <span class="n">best_input_points</span> <span class="o">=</span> <span class="n">input_points</span>
        <span class="n">best_input_labels</span> <span class="o">=</span> <span class="n">input_labels</span>

  <span class="k">return</span> <span class="n">best_mask</span><span class="p">,</span> <span class="p">(</span><span class="n">best_input_points</span><span class="p">,</span> <span class="n">best_input_labels</span><span class="p">),</span> <span class="p">(</span><span class="n">best_index</span><span class="p">,</span> <span class="n">best_score</span><span class="p">,</span> <span class="n">all_scores</span><span class="p">,</span> <span class="n">best_erosion</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">sample_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
  <span class="n">datapoint</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="s2">&quot;ir_path&quot;</span><span class="p">]))</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

  <span class="n">best_mask</span><span class="p">,</span> <span class="n">control_points</span><span class="p">,</span> <span class="n">best_values</span> <span class="o">=</span> <span class="n">bestOfMultiRoundPrediction</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
  <span class="n">evaluateMaskAccuracy</span><span class="p">(</span><span class="n">datapoint</span><span class="p">,</span> <span class="n">best_mask</span><span class="p">,</span> <span class="n">control_points</span><span class="p">,</span> <span class="n">best_values</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Misclasified pixels: 649
Total river pixels: 4958
Error rate: 13.089999999999998%
Minimum Score: 0.6977757215499878
Median Score: 0.9661865830421448
Mean Score: 0.9371496438980103
</pre></div>
</div>
<img alt="../_images/masking_28_2.png" src="../_images/masking_28_2.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Misclasified pixels: 5220
Total river pixels: 17676
Error rate: 29.53%
Minimum Score: 0.9239458441734314
Median Score: 0.9483767747879028
Mean Score: 0.9478647708892822
</pre></div>
</div>
<img alt="../_images/masking_28_5.png" src="../_images/masking_28_5.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Misclasified pixels: 1234
Total river pixels: 8032
Error rate: 15.36%
Minimum Score: 0.8378064036369324
Median Score: 0.9529841542243958
Mean Score: 0.945024847984314
</pre></div>
</div>
<img alt="../_images/masking_28_8.png" src="../_images/masking_28_8.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Misclasified pixels: 8550
Total river pixels: 14306
Error rate: 59.77%
Minimum Score: 0.8160128593444824
Median Score: 0.8909616470336914
Mean Score: 0.8871645927429199
</pre></div>
</div>
<img alt="../_images/masking_28_11.png" src="../_images/masking_28_11.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Misclasified pixels: 290079
Total river pixels: 12585
Error rate: 2304.96%
Minimum Score: 0.6994831562042236
Median Score: 0.785735011100769
Mean Score: 0.7816380262374878
</pre></div>
</div>
<img alt="../_images/masking_28_14.png" src="../_images/masking_28_14.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Misclasified pixels: 137032
Total river pixels: 11304
Error rate: 1212.24%
Minimum Score: 0.638766884803772
Median Score: 0.8547325134277344
Mean Score: 0.8219730257987976
</pre></div>
</div>
<img alt="../_images/masking_28_17.png" src="../_images/masking_28_17.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># model = predictor.features</span>

<span class="c1"># for param in model.parameters():</span>
<span class="c1">#   param.requires_grad = False</span>

<span class="c1"># num_features = model.fc.in_features</span>
<span class="c1"># classifier = torch.nn.Linear(num_features, 2)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for name, module in sam.named_modules():</span>
<span class="c1">#   print(name, module)</span>
</pre></div>
</div>
</div>
</div>
<p>NOTE TO SELF:<br />
ir_image_{x} matches with cropped_{x-1} and with truth_{x}
ir images are degree in celsius</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./chapters"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="discussion.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Dataset Realignment Discussion</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="elwha.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Cold Water Refuge Mapping</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Stefan Todoran, University of Washington<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>